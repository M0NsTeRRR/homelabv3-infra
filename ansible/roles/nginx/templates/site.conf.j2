#jinja2: lstrip_blocks: "True"
server {
  listen {{ item.ssl_port }} ssl http2;
  listen [::]:{{ item.ssl_port }} ssl http2;

  server_name {{ item.server_name }}{% if item.additional_server_name is defined %}, {% for additional_server_name in item.additional_server_name %}{{ additional_server_name }}{% if not loop.last %}, {% endif %}{% endfor %}{% endif %};

  ssl_client_certificate /etc/nginx/ssl/ca.crt;
  ssl_certificate /etc/nginx/ssl/{{ item.server_name }}-fullchain.crt;
  ssl_certificate_key /etc/nginx/ssl/{{ item.server_name }}.key;
  {% if item.ssl_verify_client %}
  ssl_verify_client {{ item.ssl_verify_client }};
  {% endif %}

  add_header X-Frame-Options "SAMEORIGIN" always;
  add_header X-XSS-Protection "1; mode=block" always;
  add_header X-Content-Type-Options "nosniff" always;
  add_header Referrer-Policy "strict-origin-when-cross-origin" always;
  {% if item.enable_content_security %}
  add_header Content-Security-Policy "default-src 'self'" always;
  {% endif %}
  add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;
  add_header Permissions-Policy "accelerometer=(), ambient-light-sensor=(), autoplay=(), battery=(), camera=(), cross-origin-isolated=(), display-capture=(), document-domain=(), encrypted-media=(), execution-while-not-rendered=(), execution-while-out-of-viewport=(), fullscreen=(), geolocation=(), gyroscope=(), keyboard-map=(), magnetometer=(), microphone=(), midi=(), navigation-override=(), payment=(), picture-in-picture=(), publickey-credentials-get=(), screen-wake-lock=(), sync-xhr=(), usb=(), web-share=(), xr-spatial-tracking=(), clipboard-read=(), clipboard-write=(), gamepad=(), speaker-selection=(), conversion-measurement=(), focus-without-user-activation=(), hid=(), idle-detection=(), interest-cohort=(), serial=(), sync-script=(), trust-token-redemption=(), window-placement=(), vertical-scroll=()";
  add_header X-Permitted-Cross-Domain-Policies "none" always;
  add_header Cross-Origin-Embedder-Policy "same-origin" always;
  add_header Cross-Origin-Opener-Policy "same-origin" always;
  add_header Cross-Origin-Resource-Policy "same-origin" always;
  add_header Set-Cookie "Path=/; HttpOnly; Secure";

  access_log /var/log/nginx/{{ item.server_name }}.access.log;
  error_log /var/log/nginx/{{ item.server_name }}.error.log warn;

  {% with locations=item.locations %}
    {% include "nginx_locations_block.j2" %}
  {% endwith %}
}

{% if item.http and item.http.enable %}
server {
  listen 80;
  listen [::]:80;

  server_name {{ item.server_name }};

  {% with locations=item.http.locations %}
    {% include "nginx_locations_block.j2" %}
  {% endwith %}

  {% if item.http.redirection is not defined or item.http.redirection %}
  location / {
    return 301 https://$server_name$request_uri;
  }
  {% endif %}
}
{% endif %}