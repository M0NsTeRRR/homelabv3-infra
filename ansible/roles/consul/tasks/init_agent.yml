---
- name: Create agent token
  ansible.builtin.uri:
    url: "https://{{ groups[consul_server_group][0].hostname }}:8501/v1/acl/token"
    status_code: 200
    method: PUT
    headers:
      Content-Type: application/json
      X-Consul-Token: "{{ consul_token_initial_management }}"
    client_cert: "{{ consul_client_cert }}"
    client_key: "{{ consul_client_key }}"
    return_content: true
    body_format: json
    body: "{{ lookup('template', 'create_agent_token.json.json.j2') }}"
  register: agent_token

- name: Apply agent token
  ansible.builtin.uri:
    url: "https://{{ inventory_hostname }}:8501/v1/agent/token/acl_token"
    status_code: 200
    method: PUT
    headers:
      Content-Type: application/json
      X-Consul-Token: "{{ consul_token_initial_management }}"
    client_cert: "{{ consul_client_cert }}"
    client_key: "{{ consul_client_key }}"
    return_content: true
    body_format: json
    body:
      Token: "{{ agent_token.SecretID }}"
