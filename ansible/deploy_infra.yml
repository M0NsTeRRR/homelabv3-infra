---
- name: Configure status infra
  hosts: status
  become: true
  roles:
    - nodejs
    - uptime_kuma
    - caddy
    - runrestic

- name: Configure DNS servers
  hosts: dns
  become: true
  roles:
    - self_signed_cert
    - postgresql
    - nginx
    - dnsdist
    - powerdns_recursor
    - powerdns_authoritative

- name: Configure DHCP servers
  hosts: dhcp
  become: true
  roles:
    - self_signed_cert
    - kea_dhcp
    - ntp

- name: Configure kubernetes
  hosts: kubernetes
  become: true
  roles:
    - kubectl
    - common_kubernetes
    - k3s

- name: Configure kube-vip
  hosts: kubernetes_master
  become: true
  roles:
    - kube_vip

- name: Deploy kubernetes services
  hosts: kubernetes_master[0]
  become: true
  roles:
    - cilium
    - metallb
    - role: traefik
    - role: traefik
      vars:
        traefik_external_ips:
          - 192.168.10.101
          - 2a0c:b641:2c0:110::101
        traefik_namespace: ingress-internal
        traefik_default_ingress_class: true
        traefik_ingress_class_name: ingress-internal
    - longhorn
    - vault
    - cert_manager
    - trust_manager
    - role: external_dns
    - role: external_dns
      vars:
        external_dns_namespace: "external-dns-internal"
        external_dns_vault_role: external-dns-internal
        external_dns_vault_inject_secret: secret/data/homelab/prod/external_dns/internal
        external_dns_envs:
          - EXTERNAL_DNS_PDNS_SERVER
          - EXTERNAL_DNS_PDNS_API_KEY
          - EXTERNAL_DNS_PDNS_TLS_ENABLED
          - EXTERNAL_DNS_TLS_CA
        external_dns_tls_envs:
          - EXTERNAL_DNS_TLS_CA
        external_dns_args: "--source=ingress --provider=pdns {% for domain in local_domains %}--domain-filter={{ domain }}{% if not loop.last %} {% endif %}{% endfor %} --registry=txt --txt-owner-id=homelab.kubernetes --ingress-class=ingress-internal --default-targets=192.168.10.101 --default-targets=2a0c:b641:2c0:110::101"
    - argocd
