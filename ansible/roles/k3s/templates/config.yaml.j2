node-name: {{ k3s_nodename }}

data-dir: /var/lib/rancher/k3s

{% if inventory_hostname != groups[k3s_master_group][0] %}token-file: /var/lib/rancher/k3s/server/node-token{% endif %}

{% if inventory_hostname != groups[k3s_master_group][0] %}
server: {{ k3s_join_url }}
{% else %}
cluster-init: true
{% endif %}

{% if inventory_hostname in groups[k3s_master_group] %}
tls-san: {{ k3s_ha_controlplane_ip }}

secrets-encryption: true

node-taint: node-role.kubernetes.io/master=true:NoSchedule

kube-controller-manager-arg: node-cidr-mask-size-ipv6={{ (k3s_service_cidr_ipv6 | split('/'))[1] }}
cluster-cidr: {{ k3s_cluster_cidr_ipv4 }},{{ k3s_cluster_cidr_ipv6 }}
service-cidr: {{ k3s_service_cidr_ipv4 }},{{ k3s_service_cidr_ipv6 }}

flannel-backend: none
disable-network-policy: true
disable-kube-proxy: true

disable: traefik,servicelb,metrics-server,local-storage

write-kubeconfig-mode: 600
write-kubeconfig: /etc/rancher/k3s/kubeconfig
{% endif %}