---
- name: Configure base infra
  hosts: all,!cloud,!kubernetes
  become: true
  roles:
    - self_signed_cert
    - lego
    - opentelemetry_collector

- name: Configure status infra
  hosts: status
  become: true
  roles:
    - nodejs
    - uptime_kuma
    - caddy
    - runrestic

- name: Configure DNS servers
  hosts: dns
  become: true
  roles:
    - postgresql
    - caddy
    - dnsdist
    - powerdns_recursor
    - powerdns_authoritative

- name: Configure DHCP servers
  hosts: dhcp
  become: true
  roles:
    - kea_dhcp
    - ntp

- name: Configure VPN server
  hosts: vpn
  become: true
  roles:
    - wireguard

- name: Configure kubernetes
  hosts: kubernetes
  become: true
  roles:
    - swap
    - role: apt
      vars:
        apt_unattended_automatic_reboot: false
    - kubectl
    - k3s

- name: Configure kube-vip
  hosts: kubernetes_master
  become: true
  roles:
    - kube_vip

- name: Deploy kubernetes services
  hosts: kubernetes_master[0]
  become: true
  tasks:
    - name: Create required k8s namespace
      kubernetes.core.k8s:
        api_version: v1
        kind: Namespace
        name: "{{ item }}"
        wait: true
        wait_timeout: 300
        kubeconfig: "{{ kubernetes_localhost_kubeconfig_path }}"
        validate_certs: true
      with_items:
        - prometheus-operator-crds
        - cilium
        - metallb-system
        - external-secrets
        - ingress-internal
        - ingress-external
        - external-snapshotter
        - rook-ceph
        - rook-ceph-cluster
        - cert-manager
        - trust-manager
        - vault
        - cert-manager-scaleway
        - external-dns-internal
        - external-dns-external
      delegate_to: localhost

    - name: "Install kubernetes base infra first part"
      kubernetes.core.k8s:
        definition: "{{ lookup('kubernetes.core.kustomize', dir='../argocd/' + item, enable_helm=True) }}"
        wait: true
        wait_timeout: 300
        kubeconfig: "{{ kubernetes_localhost_kubeconfig_path }}"
        validate_certs: true
      with_items:
        - monitoring/prometheus-operator-crds
        - infra/cilium
        - infra/metallb-system
        - infra/external-secrets
        - infra/ingress-internal
        - infra/ingress-external
        - backup/external-snapshotter
        - storage/rook-ceph
        - storage/rook-ceph-cluster
        - infra/cert-manager
        - infra/trust-manager
      delegate_to: localhost

    - name: Install vault
      ansible.builtin.include_role:
        name: vault

    - name: "Install kubernetes base infra last part"
      kubernetes.core.k8s:
        definition: "{{ lookup('kubernetes.core.kustomize', dir='../argocd/' + item, enable_helm=True) }}"
        wait: true
        wait_timeout: 300
        kubeconfig: "{{ kubernetes_localhost_kubeconfig_path }}"
        validate_certs: true
      with_items:
        - infra/cert-manager-scaleway
        - infra/external-dns-internal
        - infra/external-dns-external
      delegate_to: localhost

    - name: Install argocd
      ansible.builtin.include_role:
        name: argocd

- name: Configure Vault unseal
  hosts: dns,vpn
  become: true
  roles:
    - vault_unseal
