#!/usr/sbin/nft -f

flush ruleset

table inet filter {
  chain input {
    type filter hook input priority 0; policy drop;

    # Allow responses to established connections
    ct state established,related accept

    # Allow SSH (port 22/TCP)
    tcp dport 22 accept comment "SSH"

    # Allow ICMP (ping, error messages, etc.)
    icmp type { destination-unreachable, time-exceeded, parameter-problem, echo-request } accept comment "ICMP"

    counter drop
  }

  chain output {
    type filter hook output priority 0; policy drop;

    # Allow responses to established connections
    ct state established,related accept

    # Allow DNS (port 53/TCP and UDP)
    tcp dport 53 accept comment "DNS"
    udp dport 53 accept comment "DNS"

    # Allow DoT (port 853/TCP)
    tcp dport 853 accept comment "DoT"

    # Allow NTP (port 123/UDP)
    udp dport 123 accept comment "NTP"

    # Allow HTTP (port 80/TCP)
    tcp dport 80 accept comment "HTTP"

    # Allow HTTPS/DoH (port 443/TCP and UDP)
    tcp dport 443 accept comment "HTTPS/DoH"
    udp dport 443 accept comment "HTTPS/DoH"

    # Allow Traceroute (ports 33434-33523/UDP)
    udp dport 33434-33523 accept comment "Traceroute"

    # Allow ICMP out
    icmp type { destination-unreachable, time-exceeded, parameter-problem, echo-request } accept comment "ICMP"

    counter drop
  }

  chain forward {
    type filter hook forward priority 0; policy drop;

    # Allow responses to established connections
    ct state established,related accept

    counter drop
  }
}
