---
- name: Install Nginx
  ansible.builtin.apt:
    name: "nginx{% if nginx_version is defined %}={{ nginx_version }}{% endif %}"
    update_cache: true
    state: "{{ nginx_package_state }}"
  notify:
    - Enable nginx
    - Daemon-reload
    - Restart nginx

- name: Install cryptography
  ansible.builtin.pip:
    name: "cryptography{% if nginx_cryptography_version is defined %}={{ nginx_cryptography_version }}{% endif %}"
    state: "{{ nginx_cryptography_package_state }}"
    virtualenv: "{{ nginx_venv }}"

- name: Generate Diffie-Hellman parameters
  community.crypto.openssl_dhparam:
    path: /etc/nginx/dhparam.key
  vars:
    ansible_python_interpreter: "{{ nginx_venv }}/bin/python"

- name: Remove default Nginx configuration
  ansible.builtin.file:
    path: "{{ item }}"
    state: absent
  with_items:
    - /etc/nginx/sites-available/default
    - /etc/nginx/sites-enabled/default
    - /var/www/html
  notify: Restart nginx

- name: Configure default Nginx configuration
  ansible.builtin.copy:
    src: nginx.conf
    dest: /etc/nginx/nginx.conf
    owner: root
    group: root
    mode: "0640"
  notify:
    - Restart nginx

- name: Setup configurations
  ansible.builtin.include_tasks: configure.yml
  with_items: "{{ nginx_configuration }}"
