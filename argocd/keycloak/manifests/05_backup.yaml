---
apiVersion: k8up.io/v1
kind: PreBackupPod
metadata:
  name: postgres-backup
spec:
  backupCommand: sh -c 'pg_dump -h keycloak-cluster-rw --clean'
  pod:
    spec:
      containers:
        - name: postgres-dump
          image: postgres:16.0
          command:
            - 'sleep'
            - 'infinity'
          env:
            - name: POSTGRES_USER
              valueFrom:
                secretKeyRef:
                  name: keycloak-vault
                  key: POSTGRES_USER
            - name: POSTGRES_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: keycloak-vault
                  key: POSTGRES_PASSWORD
            - name: POSTGRES_DB
              value: keycloak
      volumes:
        - name: postgres-vault
          secret:
            secretName: postgres-vault
---
apiVersion: k8up.io/v1
kind: Schedule
metadata:
  name: backup-schedule
spec:
  backend:
    repoPasswordSecretRef:
      name: backup-vault
      key: RESTIC_PASSWORD
    s3:
      endpoint: https://s3.eu-central-003.backblazeb2.com
      bucket: unicornafk-homelab
      accessKeyIDSecretRef:
        name: backup-vault
        key: S3_ACCESS_KEY
      secretAccessKeySecretRef:
        name: backup-vault
        key: S3_SECRET_KEY
  backup:
    schedule: '0 2 * * *'
    failedJobsHistoryLimit: 3
    successfulJobsHistoryLimit: 2
  check:
    schedule: '0 1 * * 1'
    failedJobsHistoryLimit: 3
    successfulJobsHistoryLimit: 2
  prune:
    schedule: '0 1 * * 0'
    failedJobsHistoryLimit: 3
    successfulJobsHistoryLimit: 2
    retention:
      keepLast: 3
      keepDaily: 7
      keepWeekly: 4
      keepMonthly: 6